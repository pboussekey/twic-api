<?php
/**
 * TheStudnet (http://thestudnet.com)
 *
 * Page
 */
namespace Application\Service;

use Dal\Service\AbstractService;
use Application\Model\PageUser as ModelPageUser;
use Application\Model\PageRelation as ModelPageRelation;
use Application\Model\Page as ModelPage;
use Application\Model\Role as ModelRole;
use Application\Model\Conversation as ModelConversation;
use JRpc\Json\Server\Exception\JrpcException;
use ZendService\Google\Gcm\Notification as GcmNotification;
use Zend\Db\Sql\Predicate\IsNull;

/**
 * Class Page
 */
class Page extends AbstractService
{

    /**
     * Check if is admin of the page id
     *
     * @param int $id
     * @return boolean
     */
    public function isAdmin($id)
    {
        if($this->getServiceUser()->isStudnetAdmin()){
            return true;
        }
        $identity = $this->getServiceUser()->getIdentity();
        $ar_pu = $this->getServicePageUser()->getListByPage($id, ModelPageUser::ROLE_ADMIN);

        return (in_array($identity['id'], $ar_pu[$id]));
    }

    /**
     *
     *@invokable
     *
     * Get List Page By Email
     *
     * @param string $email
     * @return array
     */
    public function getListByEmail($email)
    {
        $domain = explode("@", $email)[1];
        $res_page = $this->getMapper()->getListWithDomain();
        $ar_pages =  [];
        foreach($res_page as $m_page){
            $page_domains = explode(',', $m_page->getDomaine());
            if(in_array($domain, $page_domains)){
                $ar_pages[] = $m_page;
            }
        }
        return $ar_pages;
    }

    /**
     * Get custom Field
     *
     * @invokable
     *
     * @param string $libelle
     * @param int    $id
     *
     * @return \Application\Model\Page
     */
    public function getCustom($libelle = null, $id = null)
    {
        $res_page = $this->getMapper()->getCustom($libelle, $id);

        if ($res_page->count() <= 0) {
            throw new JrpcException('No custom fields for ' . $libelle);
        }

        return $res_page->current();
    }

    /**
     * Add Page
     *
     * @invokable
     *
     * @param string $title
     * @param string $description
     * @param string $confidentiality
     * @param string $type
     * @param string $logo
     * @param string $admission
     * @param string $background
     * @param string $start_date
     * @param string $end_date
     * @param string $location
     * @param int    $page_id
     * @param array  $users
     * @param array  $tags
     * @param array  $docs
     * @param int    $owner_id
     * @param array  $address,
     * @param string $short_title,
     * @param string $website,
     * @param string $phone,
     * @param string $libelle,
     * @param string $custom,
     * @param string $subtype,
     * @param int    $circle_id
     * @param bool   $is_published
     * @param string   $domaine
     *
     * @return int
     */
    public function add(
        $title,
        $description,
        $type,
        $confidentiality = 2,
        $logo = null,
        $admission = null,
        $background = null,
        $start_date = null,
        $end_date = null,
        $location = null,
        $page_id = null,
        $users = [],
        $tags = [],
        $docs = [],
        $owner_id = null,
        $address = null,
        $short_title = null,
        $website = null,
        $phone = null,
        $libelle = null,
        $custom = null,
        $subtype = null,
        $circle_id = null,
        $is_published = null,
        $domaine = null
    ) {

        $identity = $this->getServiceUser()->getIdentity();

        //Si un non admin esaye de crÃ©er une organization
        if(!$this->getServiceUser()->isStudnetAdmin() && $type === ModelPage::TYPE_ORGANIZATION) {
            throw new JrpcException('Unauthorized operation page.add', -38003);
        }

        if(null === $page_id  && $type === ModelPage::TYPE_COURSE && (!$this->getServiceUser()->isStudnetAdmin()  || !$this->isAdmin($page_id))) {

            throw new JrpcException('Unauthorized operation page.add', -38003);
        }

        $user_id = $identity['id'];
        $formattedWebsite = $this->getFormattedWebsite($website);

        if (null === $confidentiality) {
            $confidentiality = ModelPage::CONFIDENTIALITY_SECRET;
        }

        if(null === $admission) {
            $admission = $confidentiality === ModelPage::CONFIDENTIALITY_PUBLIC ? ModelPage::ADMISSION_FREE : ModelPage::ADMISSION_OPEN;
        }

        if(!is_array($address)){
            $address = null;
        }

        $conversation_id = null;
        if ($type !== ModelPage::TYPE_ORGANIZATION) {
            $name = lcfirst(implode('', array_map("ucfirst", preg_split("/[\s]+/", preg_replace('/[^a-z0-9\ ]/', '', strtolower(str_replace('-', ' ', $title)))))));
            $conversation_id = $this->getServiceConversation()->_create(ModelConversation::TYPE_CHANNEL, null, null, $name);
        } else {
            $confidentiality = 0;
        }

        if (null === $owner_id) {
            $owner_id = $user_id;
        }

        if(null !== $start_date) {
            $start_date = (new \DateTime($start_date))->format('Y-m-d H:i:s');
        }

        if(null !== $end_date) {
            $end_date = (new \DateTime($end_date))->format('Y-m-d H:i:s');
        }

        $m_page = $this->getModel()
            ->setTitle($title)
            ->setLogo($logo)
            ->setBackground($background)
            ->setDescription($description)
            ->setConfidentiality($confidentiality)
            ->setAdmission($admission)
            ->setStartDate($start_date)
            ->setEndDate($end_date)
            ->setLocation($location)
            ->setType($type)
            ->setUserId($user_id)
            ->setOwnerId($user_id)
            ->setCustom($custom)
            ->setLibelle($libelle)
            ->setWebsite($formattedWebsite)
            ->setPhone($phone)
            ->setIsPublished($is_published)
            ->setSubtype($subtype)
            ->setConversationId($conversation_id)
            ->setShortTitle($short_title)
            ->setDomaine($domaine) /** @TODO check admin **/
            ->setCreatedDate((new \DateTime('now', new \DateTimeZone('UTC')))->format('Y-m-d H:i:s'));

        if ($address !== null) {
            $address = $this->getServiceAddress()->getAddress($address);
            if ($address && null !== ($address_id = $address->getId())) {
                $m_page->setAddressId($address_id);
            }
        }

        $this->getMapper()->insert($m_page);
        $id = (int)$this->getMapper()->getLastInsertValue();

        if (null !== $page_id) {
            $mm_page = $this->getLite($page_id);
            if ($type === ModelPage::TYPE_ORGANIZATION && $mm_page->getType() === ModelPage::TYPE_ORGANIZATION) {
                $this->getServicePageRelation()->add($id, $page_id, ModelPageRelation::TYPE_MEMBER);
            } else {
                $this->getServicePageRelation()->add($id, $page_id, ModelPageRelation::TYPE_OWNER);
            }
        }

        if (null !== $circle_id) {
            $this->getServiceCircle()->addOrganizations($circle_id, $id);
        }

        if (!is_array($users)) {
            $users = [];
        }
        if (!is_array($docs)) {
            $docs = [];
        }

        $is_present = false;
        foreach ($users as &$ar_u) {
            if(isset($ar_u['user_email'])) {
                $ar_u['user_id'] = $this->getServiceUser()->_add(null, null, $ar_u['user_email'], null, null, null, null, null, null, null, null);
                $ar_u['user_email'] = null;
            }
            if (isset($ar_u['user_id']) && $ar_u['user_id'] === $m_page->getOwnerId()) {
                $is_present = true;
                $ar_u['role'] = ModelPageUser::ROLE_ADMIN;
                $ar_u['state'] = ModelPageUser::STATE_MEMBER;
            }

            if($type === ModelPage::TYPE_ORGANIZATION) {
                $this->getServiceUser()->addOrganizationIfNotExist($id, $ar_u['user_id']);
            }
        }
        if (! $is_present && (!$this->getServiceUser()->isStudnetAdmin() || $type !== ModelPage::TYPE_ORGANIZATION)) {
            $users[] = [
              'user_id' => $m_page->getOwnerId(),
              'role' => ModelPageUser::ROLE_ADMIN,
              'state' => ModelPageUser::STATE_MEMBER
            ];
        }
        if (null !== $users) {
            $this->getServicePageUser()->addFromArray($id, $users);
        }
        if (null !== $tags) {
            $this->getServicePageTag()->_add($id, $tags);
        }
        if (null !== $docs) {
            $this->getServicePageDoc()->_add($id, $docs);
        }

        if ($type !== ModelPage::TYPE_ORGANIZATION && $type !== ModelPage::TYPE_COURSE) {
            /*$sub=[];
            if (null !== $page_id) {
                $sub[] = 'EP'.$page_id;
            } else {
                $sub[] = 'EU'.$owner_id;
            }*/

            $this->getServicePost()->addSys(
                'PP'.$id,
                '',
                [
                'state' => 'create',
                'user' => $owner_id,
                'parent' => $page_id,
                'page' => $id,
                'type' => $type,
                ],
                'create',
                null/*sub*/,
                null/*parent*/,
                $page_id/*page*/,
                $owner_id/*user*/,
                'page',
                $page_id
            );
        }

        return $id;
    }

    /**
     * Add Tags
     *
     * @invokable
     *
     * @param int    $id
     * @param string $tag
     *
     * @return int
     */
    public function addTag($id, $tag)
    {
        return $this->getServicePageTag()->add($id, $tag);
    }

    /**
     * Remove Tags
     *
     * @invokable
     *
     * @param int $id
     * @param int $tag_id
     *
     * @return int
     */
    public function removeTag($id, $tag_id)
    {
        return $this->getServicePageTag()->remove($id, $tag_id);
    }

    /**
     * Add Document
     *
     * @invokable
     *
     * @param $id
     * @param $library
     * @param $notify
     *
     **/
    public function addDocument($id, $library, $notify)
    {

        if(!$this->isAdmin($id)) {
            throw new JrpcException('Unauthorized operation page.addDocument', -38003);
        }
        return $this->getServicePageDoc()->add($id, $library, $notify);
    }

    /**
     * Delete Document
     *
     * @invokable
     *
     * @param $id
     * @param $library_id
     **/
    public function deleteDocument($id, $library_id)
    {
        if(!$this->isAdmin($id)) {
            throw new JrpcException('Unauthorized operation page.addDocument', -38003);
        }
        return $this->getServicePageDoc()->delete($library_id);
    }

    /**
     * Delete Document
     *
     * @invokable
     *
     * @param $library_id
     **/
    public function getListDocument($id, $filter = null)
    {
        return $this->getServiceLibrary()->getList($filter, null, null, null, null, $id);
    }

    /**
     * Update Page
     *
     * @invokable
     *
     * @param int    $id
     * @param string $title
     * @param string $logo
     * @param string $background
     * @param string $description
     * @param string $admission
     * @param string $start_date
     * @param string $end_date
     * @param string $location
     * @param array  $users
     * @param array  $tags
     * @param array  $docs
     * @param int    $owner_id
     * @param int    $page_id
     * @param array  $address
     * @param string $short_title
     * @param string $website
     * @param string $phone
     * @param string $libelle
     * @param string $custom
     * @param int    $circle_id
     * @param bool   $is_published
     * @param int $confidentiality
     *
     *
     * @return int
     */
    public function update(
        $id,
        $title=null,
        $logo=null,
        $background=null,
        $description=null,
        $admission=null,
        $start_date = null,
        $end_date = null,
        $location = null,
        $users = null,
        $tags = null,
        $docs = null,
        $owner_id = null,
        $page_id = null,
        $address = null,
        $short_title = null,
        $website = null,
        $phone = null,
        $libelle = null,
        $custom = null,
        $circle_id = null,
        $is_published = null,
        $confidentiality = null,
        $domaine = null
    ) {
        if(!$this->getServiceUser()->isStudnetAdmin() &&  !$this->isAdmin($id)) {
            throw new JrpcException('Unauthorized operation page.update', -38003);
        }

        if(null !== $start_date) {
            $start_date = (new \DateTime($start_date))->format('Y-m-d H:i:s');
        }
        if(null !== $end_date) {
            $end_date = (new \DateTime($end_date))->format('Y-m-d H:i:s');
        }
        $user_id = $this->getServiceUser()->getIdentity()['id'];
        $formattedWebsite = $this->getFormattedWebsite($website);
        $m_page = $this->getModel()
            ->setId($id)
            ->setTitle($title)
            ->setLogo($logo)
            ->setBackground($background)
            ->setDescription($description)
            ->setStartDate($start_date)
            ->setEndDate($end_date)
            ->setLocation($location)
            ->setUserId($user_id)
            ->setOwnerId($owner_id)
            ->setIsPublished($is_published)
            ->setCustom($custom)
            ->setLibelle($libelle)
            ->setWebsite($formattedWebsite)
            ->setPhone($phone)
            ->setShortTitle($short_title)
            ->setConfidentiality($confidentiality)
            ->setAdmission($admission)
            ->setDomaine($domaine); /** @TODO check admin **/

        if ($address !== null) {
            if($address === 0) {
                $m_page->setAddressId(new IsNull());
            }
            else{
                $address = $this->getServiceAddress()->getAddress($address);
                if ($address && null !== ($address_id = $address->getId())) {
                    $m_page->setAddressId($address_id);
                }
            }
        }
        $tmp_m_page = $this->getLite($id);
        if (null !== $users) {
            $is_present = false;
            foreach ($users as &$ar_u) {
                if(isset($ar_u['user_email'])) {
                    $ar_u['user_id'] = $this->getServiceUser()->add(null, null, $ar_u['user_email'], null, null, null, null, null, null, null, $id);
                }
                if ($ar_u['user_id'] === $tmp_m_page->getOwnerId()) {
                    $is_present = true;
                    $ar_u['role'] = ModelPageUser::ROLE_ADMIN;
                    $ar_u['state'] = ModelPageUser::STATE_MEMBER;

                }
            }
            $this->getServicePageUser()->replace($id, $users);
        }
        if (null !== $page_id) {
            $this->getServicePageRelation()->add($id, $page_id, ModelPageRelation::TYPE_OWNER);
        }
        if (null !== $circle_id) {
            $this->getServiceCircle()->addOrganizations($circle_id, $id);
        }
        if (null !== $tags) {
            $this->getServicePageTag()->replace($id, $tags);
        }
        if (null !== $docs) {
            $this->getServicePageDoc()->replace($id, $docs);
        }

        //@TODO voir ce bout de code avec CRO
        if ($is_published === true) {
            $res_post = $this->getServicePost()->getListId(null, null, $id, null, true);
            $date = (new \DateTime('now', new \DateTimeZone('UTC')))->format('Y-m-d H:i:s');
            foreach ($res_post as $m_post) {
                $this->getServicePostSubscription()->add(
                    'PP'.$id,
                    $m_post->getId(),
                    $date,
                    'UPDATE',
                    $owner_id
                );
            }
            if(!$tmp_m_page->getIsPublished() && $tmp_m_page->getType() == ModelPage::TYPE_COURSE) {
                $ar_pages = [];
                $res_user = $this->getServiceUser()->getLite($this->getServicePageUser()->getListByPage($id)[$id]);
                foreach($res_user as $m_user) {

                    // if user is not
                    if(!$m_user->getIsActive()){
                        continue;
                    }

                    $m_organization = false;
                    if($m_user->getOrganizationId()) {
                        if(!array_key_exists($m_user->getOrganizationId(), $ar_pages)) {
                            $ar_pages[$m_user->getOrganizationId()] = $this->getLite($m_user->getOrganizationId());
                        }
                        $m_organization = $ar_pages[$m_user->getOrganizationId()];
                    }
                    if($m_user->getId() == $user_id ){
                      continue;
                    }

                    try{
                        if($m_user->getHasEmailNotifier() === 1) {
                            $prefix = ($m_organization !== false && is_string($m_organization->getLibelle()) && !empty($m_organization->getLibelle())) ?
                            $m_organization->getLibelle() : null;

                            $url = sprintf("https://%s%s/page/course/%s/timeline", ($prefix ? $prefix.'.':''),  $this->container->get('config')['app-conf']['uiurl'], $tmp_m_page->getId());
                            $this->getServiceMail()->sendTpl(
                                'tpl_coursepublished', $m_user->getEmail(), [
                                'pagename' => $tmp_m_page->getTitle(),
                                'firstname' => $m_user->getFirstName(),
                                'pageurl' => $url
                                ]
                            );
                        }

                        //syslog(1, 'PPM'.$page_id.'_'.$m_user->getId());

                        $this->getServicePost()->addSys(
                            'PPM'.$id.'_'.$m_user->getId(),
                            '',
                            [
                                'state' => 'member',
                                'user' => $m_user->getId(),
                                'page' => $id,
                                'type' => $tmp_m_page->getType(),
                            ],
                            'member',
                            ['M'.$m_user->getId()]/*sub*/,
                            null/*parent*/,
                            $id/*page*/,
                            $m_user->getId()/*user*/,
                            'page',
                            $id
                        );

                        $gcm_notification = new GcmNotification();
                        $gcm_notification->setTitle($tmp_m_page->getTitle())
                            ->setSound("default")
                            ->setColor("#00A38B")
                            ->setIcon("icon")
                            ->setTag("PAGEADD".$id)
                            ->setBody("You have just been added to the course " . $tmp_m_page->getTitle());

                        $this->getServiceFcm()->send($m_user->getId(), null, $gcm_notification, Fcm::PACKAGE_TWIC_APP);
                    }
                    catch (\Exception $e) {
                        syslog(1, 'Model name does not exist Page publish <MESSAGE> ' . $e->getMessage() . '  <CODE> ' . $e->getCode());
                    }
                }


            }

        }

        if (is_numeric($tmp_m_page->getConversationId()) && null !== $title) {
            $name = lcfirst(implode('', array_map("ucfirst", preg_split("/[\s]+/", preg_replace('/[^a-z0-9\ ]/', '', strtolower(str_replace('-', ' ', $title)))))));
            $conversation_id = $this->getServiceConversation()->update($tmp_m_page->getConversationId(), $name);
        }

        return $this->getMapper()->update($m_page);
    }



    /**
     * Delete Page
     *
     * @invokable
     *
     * @param  int $id
     * @return int
     */
    public function delete($id)
    {
        if (!is_array($id)) {
            $id = [$id];
        }
        $m_page = $this->getModel()->setId($id)
            ->setDeletedDate((new \DateTime('now', new \DateTimeZone('UTC')))->format('Y-m-d H:i:s'));

        $ret = $this->getMapper()->update($m_page);
        foreach ($id as $i) {
            $this->getServicePost()->hardDelete('PP'.$i);
            $this->getServiceEvent()->sendData($i, 'page.delete', ['PP'.$i]);
            $m_tmp_page = $this->getLite($i);
            if ($m_tmp_page->getType() === ModelPage::TYPE_ORGANIZATION) {
                $this->getServiceUser()->removeOrganizationId($i);
            }
        }

        return $ret;
    }

    /**
     * Reactivate Page
     *
     * @invokable
     *
     * @param  int $id
     * @return int
     */
    public function reactivate($id)
    {
        $m_page = $this->getModel()->setId($id)->setDeletedDate(new \Zend\Db\Sql\Predicate\IsNull());

        return $this->getMapper()->update($m_page);
    }

    /**
     * Get Page
     *
     * @invokable
     *
     * @param int    $id
     * @param int    $parent_id
     * @param string $type
     */
    public function get($id = null, $parent_id = null, $type = null)
    {
        if (null === $id && null === $parent_id) {
            throw new \Exception('Error: params is null');
        }
        $identity = $this->getServiceUser()->getIdentity();
        $is_admin = (in_array(ModelRole::ROLE_ADMIN_STR, $identity['roles']));

        $res_page = $this->getMapper()->get($identity['id'], $id, $parent_id, $type, $is_admin);

        foreach ($res_page as $m_page) {
            $m_page->setTags($this->getServicePageTag()->getList($m_page->getId()));
            $this->getOwner($m_page);
        }

        $res_page->rewind();

        if (is_array($id)) {
            $ar_page = $res_page->toArray(['id']);
            foreach ($id as $i) {
                if (!isset($ar_page[$i])) {
                    $ar_page[$i] = null;
                }
            }
        }

        return (is_array($id)) ? $ar_page : $res_page->current();
    }

    /**
     * Get Page Lite
     *
     * @invokable
     *
     * @param  int $id
     * @return \Application\Model\Page
     */
    public function getLite($id = null, $conversation_id = null)
    {

        return $this->getMapper()->select($this->getModel()->setId($id)->setConversationId($conversation_id))->current();
    }

    /**
    * Get list suscribed users
    *
    * @invokable
    *
    *  @param  int $id
     * @param  array  $filter
     * @param  string $search
     * @param  array $order
    * @return array
    */
    public function getListSuscribersId($id, $filter = null, $search = null, $order = null)
    {
        return $this->getServiceSubscription()->getListUserId('PP'.$id, $filter, $search, $order);
    }



    /**
     * Get Page
     *
     * @invokable
     *
     * @param  int $item_id
     * @return int
     */
    public function getIdByItem($item_id)
    {
        return $this->getMapper()->getIdByItem($item_id)->current()->getId();
    }

    /**
     * Get Page grades
     *
     * @invokable
     *
     * @param int $id
     */
    public function getGrades($id)
    {
        if (!is_array($id)) {
            $id = [$id];
        }

        $grades = [];
        foreach ($id as $i) {
            $median = $this->getMapper()->getMedian($i)->current()->getMedian();
            $avg = $this->getMapper()->getAverage($i)->current()->getAverage();
            $grades[$i] =  [
                'id' => $i,
                'median' => is_numeric($median) ? $median : null,
                'average' => is_numeric($avg) ? $avg : null
             ];
        }
        return $grades;
    }


    /**
     * Get Page grades
     *
     * @invokable
     *
     * @param int   $id
     * @param array $filter
     */
    public function getUsersGrades($id, $filter = null)
    {
        $res_grades = $this->getMapper()->usePaginator($filter)->getUsersAvg($id);
        $res_prcs = $this->getMapper()->getUsersPrc($id);
        $prcs = [];
        foreach ($res_prcs as $m_prc) {
            $prcs[$m_prc->getAverage()] = $m_prc->getPercentile();
        }
        foreach ($res_grades as $m_grade) {
            $m_grade->setPercentile($prcs[$m_grade->getAverage()]);
        }

        return [ 'list' => $res_grades, 'count' => $this->getMapper()->count() ];
    }

     /**
      * Get user grades per pages
      *
      * @invokable
      *
      * @param int $id
      * @param int $user_id
      */
    public function getUserGrades($id, $user_id)
    {
        if(!is_array($user_id)) {
            $user_id = [$user_id];
        }
        $var_grades = [];
        foreach($user_id as $u){
            $var_grades[$u] = $this->getMapper()->getUserGrades($id, $u);
        }
        return $var_grades;
    }

    /**
     * Get Page
     *
     * @invokable
     *
     * @param int    $parent_id
     * @param string $type
     * @param string $start_date
     * @param string $end_date
     * @param int    $member_id
     * @param array  $filter
     * @param bool   $strict_dates
     * @param string $search
     * @param array  $tags
     * @param int    $children_id
     *
     * @throws \Exception
     * @return \Dal\Db\ResultSet\ResultSet
     */
    public function getListId(
        $parent_id = null,
        $type = null,
        $start_date = null,
        $end_date = null,
        $member_id = null,
        $filter = null,
        $strict_dates = false,
        $search = null,
        $tags = null,
        $children_id = null,
        $is_member_admin = null, // get only les meber admin true/false
        $exclude = null,
        $is_published = null
    ) {
        if (empty($tags)) {
            $tags = null;
        }
        $identity = $this->getServiceUser()->getIdentity();
        $is_admin = (in_array(ModelRole::ROLE_ADMIN_STR, $identity['roles']));

        $mapper = $this->getMapper()->usePaginator($filter);
        $res_page = $mapper->getListId($identity['id'], $parent_id, $type, $start_date, $end_date, $member_id, $strict_dates, $is_admin, $search, $tags, $children_id, $is_member_admin, null, $exclude, $is_published);

        $ar_page = [];
        foreach ($res_page as $m_page) {
            $ar_page[] = $m_page->getId();
        }

        return [
          'list' => $ar_page,
          'count' => $mapper->count()
        ];
    }

    /**
     * Get Page
     *
     * @invokable
     *
     * @param int $parent_id
     * @param int $children_id
     *
     * @throws \Exception
     * @return \Dal\Db\ResultSet\ResultSet
     */
    public function getListRelationId($parent_id = null, $children_id = null)
    {
        if (empty($tags)) {
            $tags = null;
        }
        $identity = $this->getServiceUser()->getIdentity();
        $is_admin = (in_array(ModelRole::ROLE_ADMIN_STR, $identity['roles']));
        $res_page = $this->getMapper()->getListId($identity['id'], $parent_id, ModelPage::TYPE_ORGANIZATION, null, null, null, null, $is_admin, null, null, $children_id, null, ModelPageRelation::TYPE_MEMBER);

        $ar_page = [];

        if (null !== $parent_id) {
            if (!is_array($parent_id)) {
                $parent_id = [$parent_id];
            }
            foreach ($parent_id as $pi) {
                $ar_page[$pi] = [];
            }
        }

        if (null !== $children_id) {
            if (!is_array($children_id)) {
                $children_id = [$children_id];
            }
            foreach ($children_id as $ci) {
                $ar_page[$ci] = [];
            }
        }

        foreach ($res_page as $m_page) {
            if (is_numeric($m_page->getPageRelation()->getParentId())) {
                $ar_page[$m_page->getPageRelation()->getParentId()][] = $m_page->getId();
            }
            if (is_numeric($m_page->getPageRelation()->getPageId())) {
                $ar_page[$m_page->getPageRelation()->getPageId()][] = $m_page->getId();
            }
        }

        return $ar_page;
    }

    /**
     * Generate a formatted website url for the school.
     *
     * @param string $website
     *
     * @return string
     */
    private function getFormattedWebsite($website)
    {
        $hasProtocol = strpos($website, 'http://') === 0 || strpos($website, 'https://') === 0 || strlen($website) === 0;
        return $hasProtocol ? $website : 'http://' . $website;
    }

    /**
     * Get owner string by Page Model
     *
     * @param \Application\Model\Page $m_page
     */
    private function getOwner(\Application\Model\Page $m_page)
    {
        $owner = [];
        $res_page = $this->getServicePageRelation()->getOwner($m_page->getId());
        switch (true) {
        case $res_page->count() > 0:
            $ar_page = $this->getLite($res_page->current()->getParentId())->toArray();
            $owner = [
                'id' => $ar_page['id'],
                'text' => $ar_page['title'],
                'img' => $ar_page['logo'],
                'type' => $ar_page['type'],
            ];
            break;
        case is_numeric($m_page->getOwnerId()):
            $ar_user = $m_page->getUser()->toArray();
            $owner = [
                'id' => $ar_user['id'],
                'text' => $ar_user['firstname'] . ' ' . $ar_user['lastname'],
                'img' => $ar_user['avatar'],
                'type' => 'user',
            ];
            break;

        }

        $m_page->setOwner($owner);
    }


     /**
      * Get page counts.
      *
      * @invokable
      *
      * @param string       $start_date
      * @param string       $end_date
      * @param string       $interval_date
      * @param array|string $type
      * @param int|array $page_id
      * @param int $date_offset
      *
      * @return array
      */
    public function getCount( $start_date = null, $end_date = null, $interval_date = 'D', $type = null, $page_id  = null, $date_offset = 0)
    {

        if(null !== $page_id && !is_array($page_id)){
            $page_id = [$page_id];
        }
        $interval = $this->getServiceActivity()->interval($interval_date);
        $identity = $this->getServiceUser()->getIdentity();

        return $this->getMapper()->getCount($identity['id'], $interval, $start_date, $end_date, $page_id, $type, $date_offset);
    }

    public function getByConversationId($conversation_id)
    {
        return $this->getMapper()->select($this->getModel()->setConversationId($conversation_id))->current();
    }


    /**
     * Get Service Event
     *
     * @return Event
     */
    private function getServiceEvent()
    {
        return $this->container->get('app_service_event');
    }


    /**
     * Get Service User
     *
     * @return \Application\Service\User
     */
    private function getServiceUser()
    {
        return $this->container->get('app_service_user');
    }

    /**
     * Get Service Page User
     *
     * @return \Application\Service\PageUser
     */
    private function getServicePageUser()
    {
        return $this->container->get('app_service_page_user');
    }

    /**
     * Get Service Page Doc
     *
     * @return \Application\Service\PageDoc
     */
    private function getServicePageDoc()
    {
        return $this->container->get('app_service_page_doc');
    }

    /**
     * Get Service Page Tag
     *
     * @return \Application\Service\PageTag
     */
    private function getServicePageTag()
    {
        return $this->container->get('app_service_page_tag');
    }

    /**
     * Get Service Address
     *
     * @return \Address\Service\Address
     */
    private function getServiceAddress()
    {
        return $this->container->get('addr_service_address');
    }

    /**
     * Get Service Cicle
     *
     * @return \Application\Service\Circle
     */
    private function getServiceCircle()
    {
        return $this->container->get('app_service_circle');
    }

    /**
     * Get Service Cicle
     *
     * @return \Application\Service\PageRelation
     */
    private function getServicePageRelation()
    {
        return $this->container->get('app_service_page_relation');
    }

    /**
     * Get Service Conversation
     *
     * @return \Application\Service\Conversation
     */
    private function getServiceConversation()
    {
        return $this->container->get('app_service_conversation');
    }

    /**
     * Get Service Library
     *
     * @return \Application\Service\Library
     */
    private function getServiceLibrary()
    {
        return $this->container->get('app_service_library');
    }

    /**
     * Get Service Post Subscription
     *
     * @return \Application\Service\PostSubscription
     */
    private function getServicePostSubscription()
    {
        return $this->container->get('app_service_post_subscription');
    }

    /**
     * Get Service Subscription
     *
     * @return \Application\Service\Subscription
     */
    private function getServiceSubscription()
    {
        return $this->container->get('app_service_subscription');
    }

    /**
     * Get Service Post
     *
     * @return \Application\Service\Post
     */
    private function getServicePost()
    {
        return $this->container->get('app_service_post');
    }

    /**
     * Get Service Activity
     *
     * @return \Application\Service\Activity
     */
    private function getServiceActivity()
    {
        return $this->container->get('app_service_activity');
    }

    /**
     * Get Service Mail.
     *
     * @return \Mail\Service\Mail
     */
    private function getServiceMail()
    {
        return $this->container->get('mail.service');
    }

    /**
     * Get Service Service Conversation User.
     *
     * @return \Application\Service\Fcm
     */
    private function getServiceFcm()
    {
        return $this->container->get('fcm');
    }
}
